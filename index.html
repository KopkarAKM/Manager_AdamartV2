<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adamart - Manager Dashboard (Integrated)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, where, orderBy, limit, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBApyoL7sczxl1kDq_WgPtnYF4lyujuWgc",
            authDomain: "adamart-pos.firebaseapp.com",
            projectId: "adamart-pos",
            storageBucket: "adamart-pos.firebasestorage.app",
            messagingSenderId: "754641758734",
            appId: "1:754641758734:web:8eaa07cf10ead6ea02aa5f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        // Expose Firebase functions globally
        window.db = db; window.collection = collection; window.getDocs = getDocs; 
        window.addDoc = addDoc; window.updateDoc = updateDoc; window.deleteDoc = deleteDoc; 
        window.doc = doc; window.query = query; window.where = where; 
        window.orderBy = orderBy; window.limit = limit; window.increment = increment;
        
        document.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script>tailwind.config = { theme: { extend: { colors: { 'adamart': { 50: '#f0f9ff', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' } } } } }</script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; height: 100vh; overflow: hidden; } 
        .sidebar { transition: width 0.3s ease; background: linear-gradient(180deg, #0F2C59 0%, #1e3a5f 100%); color: white; } 
        .sidebar-item:hover { background: rgba(255,255,255,0.1); } 
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; } 
        .modal-content { background: white; border-radius: 1rem; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; } 
        .animate-spin { animation: spin 1s linear infinite; } 
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex h-full">
    <!-- SIDEBAR -->
    <aside class="sidebar w-64 flex flex-col hidden md:flex">
        <div class="p-6">
            <h2 class="text-xl font-bold tracking-wider">ADAMART</h2>
            <p class="text-xs opacity-70">Integrated System</p>
        </div>
        <nav class="flex-1 py-4 space-y-1">
            <a onclick="navigate('dashboard')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 hover:bg-white/10"><span>üìä</span> Dashboard</a>
            <a onclick="navigate('logistics')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 hover:bg-white/10 bg-white/5 border-l-4 border-blue-400"><span>üöõ</span> Logistik Toko</a>
            <a onclick="navigate('requisition')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 hover:bg-white/10"><span>üì•</span> Inbox Request</a>
            <a onclick="navigate('inventory')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 hover:bg-white/10"><span>üì¶</span> Inventory Master</a>
            <a onclick="navigate('purchase')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 hover:bg-white/10"><span>üõí</span> Purchase Order</a>
            <a onclick="navigate('shifts')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 hover:bg-white/10"><span>üïí</span> Laporan Shift</a>
            <a onclick="navigate('evoucher')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 hover:bg-white/10 text-yellow-100"><span>üé´</span> E-Voucher</a>
            <a onclick="navigate('reports')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 hover:bg-white/10"><span>üìà</span> Analisa Bisnis</a>
        </nav>
        <div class="p-4 text-xs opacity-50 text-center">v5.0 Connected</div>
    </aside>

    <!-- MAIN CONTENT -->
    <div class="flex-1 flex flex-col min-w-0 overflow-hidden">
        <header class="bg-white p-4 border-b shadow-sm flex justify-between items-center z-10">
            <h1 id="page-title" class="text-xl font-bold text-gray-800">Dashboard</h1>
            <div class="flex items-center gap-4">
                <button onclick="loadAllData()" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200" title="Refresh Data">üîÑ</button>
                <div class="text-sm text-right">
                    <div class="font-bold text-gray-800">Manager</div>
                    <div class="text-xs text-green-600">‚óè Firebase Online</div>
                </div>
            </div>
        </header>
        <main class="flex-1 overflow-y-auto p-6" id="main-container">
            <div id="loadingState" class="text-center py-20">
                <div class="animate-spin text-4xl mb-4">‚è≥</div>
                <p class="text-gray-500">Mengambil data Real-time...</p>
            </div>
            <div id="content-area" class="hidden space-y-6"></div>
        </main>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwkZVsoGXdgxck4xwOXk2fW4Oawn6diXu2bUX0sAIRFCfGeS1jTr6QjEH6Fr6-RFbnDAw/exec';
        const EVOUCHER_API_URL = "https://script.google.com/macros/s/AKfycbyQFkZW0QuBXi082jgXTsVBIy1OfVfhaQYVogvr7uBJBrCuGtkM73tTGqA1dl9ThlfL/exec";

        const BRANCHES = ["Adamart 73", "Adamart Kelanis", "Adamart Induksi"];
        const SUPPLIERS = ["PT Sumber Makmur", "CV Mitra Jaya", "Toko Grosir Berkah", "PT Indo Supplier"];
        
        // GLOBAL STATE
        const State = { 
            currentPage: 'dashboard', 
            data: { products: [], sales: [], purchases: [], requisitions: [], shifts: [], logs: [] }, 
            tempBatchItems: [], 
            charts: { line: null, doughnut: null } 
        };

        const EvoucherState = { view: 'login', users: [], selectedPeriod: '', loading: false, foundUser: null };

        // INITIAL LOAD
        document.addEventListener('firebase-ready', () => { loadAllData(); });

        // DATA FETCHING (Sekarang termasuk logs)
        async function loadAllData() {
            try {
                document.getElementById('loadingState').classList.remove('hidden'); 
                document.getElementById('content-area').classList.add('hidden');
                
                // Fetching all necessary collections concurrently
                const [pSnap, sSnap, poSnap, rSnap, shiftSnap, logSnap] = await Promise.all([
                    window.getDocs(window.collection(window.db, "products")),
                    window.getDocs(window.query(window.collection(window.db, "sales"), window.orderBy("timestamp", "desc"), window.limit(100))),
                    window.getDocs(window.collection(window.db, "purchases")),
                    window.getDocs(window.query(window.collection(window.db, "requisitions"), window.orderBy("timestamp", "desc"))),
                    window.getDocs(window.query(window.collection(window.db, "shifts"), window.orderBy("openTime", "desc"), window.limit(50))),
                    window.getDocs(window.query(window.collection(window.db, "inventory_logs"), window.orderBy("timestamp", "desc"), window.limit(50)))
                ]);
                
                // Parsing Data
                State.data.products = []; pSnap.forEach(d => State.data.products.push({ id: d.id, ...d.data() }));
                State.data.sales = []; sSnap.forEach(d => State.data.sales.push({ id: d.id, ...d.data() }));
                State.data.purchases = []; poSnap.forEach(d => State.data.purchases.push({ id: d.id, ...d.data() }));
                State.data.requisitions = []; rSnap.forEach(d => State.data.requisitions.push({ id: d.id, ...d.data() }));
                State.data.shifts = []; shiftSnap.forEach(d => State.data.shifts.push({ id: d.id, ...d.data() }));
                State.data.logs = []; logSnap.forEach(d => State.data.logs.push({ id: d.id, ...d.data() }));
                
                renderPage(); 
                document.getElementById('loadingState').classList.add('hidden'); 
                document.getElementById('content-area').classList.remove('hidden');
            } catch (e) { 
                console.error(e); 
                alert("Gagal sinkronisasi data: " + e.message); 
            }
        }

        window.navigate = (page) => { State.currentPage = page; renderPage(); };

        // ROUTER / PAGE RENDERER
        function renderPage() {
            const container = document.getElementById('content-area'); 
            const title = document.getElementById('page-title'); 
            container.innerHTML = '';
            
            // Cleanup Charts
            if(State.charts.line) { State.charts.line.destroy(); State.charts.line = null; }
            if(State.charts.doughnut) { State.charts.doughnut.destroy(); State.charts.doughnut = null; }

            switch (State.currentPage) {
                case 'dashboard': title.innerText = 'Dashboard Overview'; container.innerHTML = Pages.Dashboard(); break;
                case 'logistics': title.innerText = 'Logistik Toko (Barang Masuk)'; container.innerHTML = Pages.Logistics(); break;
                case 'requisition': title.innerText = 'Inbox Permintaan Barang'; container.innerHTML = Pages.Requisition(); break;
                case 'inventory': title.innerText = 'Inventory Master'; container.innerHTML = Pages.Inventory(); setupInventoryListeners(); break;
                case 'purchase': title.innerText = 'Purchase Orders (Supplier)'; container.innerHTML = Pages.Purchase(); break;
                case 'shifts': title.innerText = 'Laporan Shift & Keuangan'; container.innerHTML = Pages.Shifts(); break;
                case 'evoucher': title.innerText = 'E-Voucher System (Kopkar)'; const today = new Date(); EvoucherState.selectedPeriod = `${today.getMonth() + 1}-${today.getFullYear()}`; EvoucherActions.render(); break;
                case 'reports': title.innerText = 'Analisa Bisnis Lengkap'; container.innerHTML = Pages.Reports(); setTimeout(Pages.initReportCharts, 100); break;
            }
        }

        // PAGES COMPONENTS
        const Pages = {
            Dashboard: () => { 
                const pendingReq = State.data.requisitions.filter(r => r.status === 'PENDING').length;
                return `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow border-l-4 border-green-500">
                        <div class="text-gray-500 text-sm">Total Pendapatan</div>
                        <div class="text-2xl font-bold text-gray-800">${formatRp(State.data.sales.reduce((s, i) => s + (i.total || 0), 0))}</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow border-l-4 border-blue-500">
                        <div class="text-gray-500 text-sm">Total Transaksi</div>
                        <div class="text-2xl font-bold text-gray-800">${State.data.sales.length}</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow border-l-4 border-orange-500 cursor-pointer hover:bg-orange-50" onclick="navigate('requisition')">
                        <div class="text-orange-600 text-sm font-bold">Pending Request</div>
                        <div class="text-2xl font-bold text-orange-700">${pendingReq}</div>
                        <div class="text-xs text-gray-400">Klik untuk proses</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow border-l-4 border-purple-500 cursor-pointer hover:bg-purple-50" onclick="navigate('logistics')">
                        <div class="text-purple-600 text-sm font-bold">Barang Masuk</div>
                        <div class="text-2xl font-bold text-purple-700">${State.data.logs.length}</div>
                        <div class="text-xs text-gray-400">Aktivitas restock</div>
                    </div>
                </div>
                <!-- Recent Activities -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                     <div class="bg-white rounded-xl shadow p-4">
                        <h3 class="font-bold text-gray-700 mb-4">Aktivitas Penjualan Terakhir</h3>
                        <div class="overflow-auto max-h-60">
                            <table class="w-full text-sm text-left">
                                <tbody class="divide-y">
                                    ${State.data.sales.slice(0,5).map(s => `<tr><td class="py-2 text-xs text-gray-500">${new Date(s.timestamp).toLocaleTimeString()}</td><td class="py-2 font-bold text-xs">${s.area}</td><td class="py-2 text-right font-bold">${formatRp(s.total)}</td></tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                     </div>
                     <div class="bg-white rounded-xl shadow p-4">
                        <h3 class="font-bold text-gray-700 mb-4">Aktivitas Logistik Terakhir</h3>
                        <div class="overflow-auto max-h-60">
                            <table class="w-full text-sm text-left">
                                <tbody class="divide-y">
                                    ${State.data.logs.slice(0,5).map(l => `<tr><td class="py-2 text-xs text-gray-500">${new Date(l.timestamp).toLocaleDateString()}</td><td class="py-2 font-bold text-xs text-blue-600">${l.area}</td><td class="py-2 text-xs text-gray-600 truncate max-w-[150px]">${l.items.length} item diterima</td></tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                     </div>
                </div>
                `; 
            },

            // --- PAGE BARU: LOGISTICS (Monitoring Barang Masuk) ---
            Logistics: () => {
                const logs = State.data.logs;
                return `
                <div class="bg-white rounded-xl shadow overflow-hidden flex flex-col h-[calc(100vh-140px)]">
                    <div class="p-6 border-b bg-blue-50 shrink-0 flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-gray-700 text-lg">üöõ Riwayat Terima Barang (Receiving)</h3>
                            <p class="text-xs text-gray-500">Data ini berasal dari kasir saat melakukan 'Terima Barang'</p>
                        </div>
                        <button onclick="loadAllData()" class="text-blue-600 text-sm hover:underline">Refresh Data</button>
                    </div>
                    <div class="overflow-auto flex-1">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-100 sticky top-0 z-10">
                                <tr>
                                    <th class="p-4">Waktu</th>
                                    <th class="p-4">Area / Toko</th>
                                    <th class="p-4">User</th>
                                    <th class="p-4">Detail Barang Masuk</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${logs.length === 0 ? '<tr><td colspan="4" class="p-8 text-center text-gray-400">Belum ada data barang masuk.</td></tr>' : 
                                  logs.map(l => {
                                    // Parse items safely
                                    let itemsDisplay = '-';
                                    if(Array.isArray(l.items)) {
                                        itemsDisplay = l.items.map(i => `<span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded text-xs mr-1 mb-1 border border-green-200"><b>${i.name}</b>: ${i.qty}</span>`).join('');
                                    }
                                    return `
                                    <tr class="hover:bg-blue-50/30 transition">
                                        <td class="p-4 text-gray-600 whitespace-nowrap">${new Date(l.timestamp).toLocaleString('id-ID')}</td>
                                        <td class="p-4 font-bold text-blue-800">${l.area}</td>
                                        <td class="p-4 text-gray-600">${l.user || 'Admin'}</td>
                                        <td class="p-4">${itemsDisplay}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            },

            // --- PAGE UPDATE: REQUISITION (Sinkron Status) ---
            Requisition: () => { 
                const pending = State.data.requisitions.filter(r => r.status === 'PENDING'); 
                const history = State.data.requisitions.filter(r => r.status !== 'PENDING'); 
                
                // Helper to render items
                const renderItems = (itemsData) => {
                    if(Array.isArray(itemsData)) return itemsData.map(i => `${i.name} (${i.qty})`).join(', ');
                    return '-';
                };

                return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-[calc(100vh-140px)]">
                    <!-- Pending Section -->
                    <div class="bg-white rounded-xl shadow overflow-hidden flex flex-col border border-orange-200">
                        <div class="p-4 border-b bg-orange-50 shrink-0">
                            <h3 class="font-bold text-orange-700 text-lg">üì• Inbox Request (${pending.length})</h3>
                            <p class="text-xs text-orange-600">Permintaan dari kasir yang belum diproses</p>
                        </div>
                        <div class="overflow-auto flex-1">
                            ${pending.length === 0 ? '<p class="p-10 text-center text-gray-400">Tidak ada permintaan baru</p>' : 
                            `<table class="w-full text-left text-sm">
                                <thead class="bg-orange-50 text-orange-800 sticky top-0 z-10">
                                    <tr><th class="p-3">Info</th><th class="p-3">Barang</th><th class="p-3 text-right">Aksi</th></tr>
                                </thead>
                                <tbody class="divide-y">
                                    ${pending.map(r => `
                                    <tr class="hover:bg-orange-50/50">
                                        <td class="p-3">
                                            <div class="font-bold text-gray-700">${r.area}</div>
                                            <div class="text-xs text-gray-500">${new Date(r.timestamp).toLocaleDateString()}</div>
                                            <div class="text-xs text-gray-500">${r.user||'-'}</div>
                                        </td>
                                        <td class="p-3 text-xs text-gray-700 leading-relaxed">
                                            ${renderItems(r.items)}
                                        </td>
                                        <td class="p-3 text-right">
                                            <button onclick="Actions.approveReq('${r.id}')" class="bg-green-600 text-white px-3 py-1.5 rounded shadow text-xs font-bold hover:bg-green-700 transition">‚úÖ Kirim & Selesai</button>
                                        </td>
                                    </tr>`).join('')}
                                </tbody>
                            </table>`}
                        </div>
                    </div>
                    
                    <!-- History Section -->
                    <div class="bg-white rounded-xl shadow overflow-hidden flex flex-col opacity-90 hover:opacity-100 transition">
                        <div class="p-4 border-b bg-gray-50 shrink-0">
                            <h3 class="font-bold text-gray-600">Riwayat Permintaan</h3>
                        </div>
                        <div class="overflow-auto flex-1">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-gray-100 sticky top-0 z-10">
                                    <tr><th class="p-3">Tgl</th><th class="p-3">Area</th><th class="p-3">Status</th></tr>
                                </thead>
                                <tbody class="divide-y">
                                    ${history.map(r => `
                                    <tr>
                                        <td class="p-3 text-xs">${new Date(r.timestamp).toLocaleDateString()}</td>
                                        <td class="p-3 font-bold text-gray-600">${r.area}</td>
                                        <td class="p-3">${getStatusBadge(r.status)}</td>
                                    </tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`; 
            },

            Shifts: () => `<div class="bg-white rounded-xl shadow overflow-hidden flex flex-col h-[calc(100vh-140px)]"><div class="p-6 border-b bg-blue-50 shrink-0"><h3 class="font-bold text-gray-700 text-lg">Laporan Keuangan Harian</h3></div><div class="overflow-auto flex-1"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-gray-100 sticky top-0 z-10"><tr><th class="p-4">Waktu / Kasir</th><th class="p-4 text-right">Tunai (Fisik)</th><th class="p-4 text-right">QRIS</th><th class="p-4 text-right">Kasbon</th><th class="p-4 text-right font-bold">Total Real</th><th class="p-4 text-right">Selisih</th></tr></thead><tbody class="divide-y">${State.data.shifts.map(s => { const cashNet = s.actualCash - s.startCash; const totalReal = cashNet + (s.totalQris||0) + (s.totalKasbon||0); return `<tr class="hover:bg-gray-50"><td class="p-4"><div class="font-bold">${s.cashierName}</div><div class="text-xs text-gray-500">${new Date(s.openTime).toLocaleDateString()}</div><span class="bg-gray-200 px-2 rounded text-xs">${s.area}</span></td><td class="p-4 text-right font-bold text-gray-800">${formatRp(s.actualCash)}</td><td class="p-4 text-right text-blue-700">${formatRp(s.totalQris||0)}</td><td class="p-4 text-right text-orange-700">${formatRp(s.totalKasbon||0)}</td><td class="p-4 text-right font-extrabold text-gray-900">${formatRp(totalReal)}</td><td class="p-4 text-right font-bold ${s.difference < 0 ? 'text-red-600' : 'text-green-600'}">${s.difference === 0 ? '‚úÖ Pas' : formatRp(s.difference)}</td></tr>`; }).join('')}</tbody></table></div></div>`,
            
            Purchase: () => `<div class="flex justify-end mb-4"><button onclick="Modals.openBatchPO()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold">+ Buat Batch PO</button></div><div class="bg-white rounded shadow overflow-hidden h-[calc(100vh-200px)] flex flex-col"><div class="overflow-auto flex-1"><table class="w-full text-sm text-left"><thead class="bg-gray-100 sticky top-0 z-10"><tr><th class="p-4">Batch</th><th class="p-4">Supplier</th><th class="p-4">Cabang</th><th class="p-4">Status</th><th class="p-4">Items</th></tr></thead><tbody class="divide-y">${State.data.purchases.map(p=>`<tr><td class="p-4 text-blue-600 font-mono font-bold">${p.batchNumber}</td><td class="p-4">${p.supplier}</td><td class="p-4"><span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-bold border border-purple-200">${p.branch}</span></td><td class="p-4">${getStatusBadge(p.status)}</td><td class="p-4 font-medium text-gray-500">${JSON.parse(p.items).length} items</td></tr>`).join('')}</tbody></table></div></div>`,
            
            Inventory: () => `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="bg-white rounded-xl shadow p-6 lg:col-span-1 h-fit"><h3 class="font-bold text-gray-800 mb-4">üì¶ Input / Update Stok</h3><form id="stockForm" class="space-y-3"><div><label class="text-xs font-bold text-gray-500">Barcode</label><input type="text" id="barcode" class="w-full p-2 border rounded bg-gray-50" placeholder="Scan/Ketik..." required oninput="autoFill()"></div><div><label class="text-xs font-bold text-gray-500">Nama Produk</label><input type="text" id="productName" class="w-full p-2 border rounded" required></div><div class="grid grid-cols-2 gap-2"><div><label class="text-xs font-bold text-gray-500">HPP (Beli)</label><input type="number" id="hpp" class="w-full p-2 border rounded" placeholder="0"></div><div><label class="text-xs font-bold text-gray-500">Harga Jual</label><input type="number" id="price" class="w-full p-2 border rounded" placeholder="0" required></div></div><div><label class="text-xs font-bold text-gray-500">Target Cabang</label><select id="targetArea" class="w-full p-2 border rounded bg-white"><option value="adamart 73">Adamart 73</option><option value="adamart induksi">Induksi</option><option value="adamart kelanis">Kelanis</option></select></div><div class="grid grid-cols-2 gap-2"><div><label class="text-xs font-bold text-gray-500">Tambah Qty</label><input type="number" id="stockAmount" class="w-full p-2 border rounded" placeholder="0" required></div><div><label class="text-xs font-bold text-gray-500">Exp Date</label><input type="date" id="expiryDate" class="w-full p-2 border rounded"></div></div><button type="submit" class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700 mt-4">Simpan Stok</button></form></div><div class="bg-white rounded-xl shadow overflow-hidden lg:col-span-2 flex flex-col h-[calc(100vh-200px)]"><div class="p-4 border-b bg-gray-50 shrink-0"><input type="text" placeholder="üîç Cari produk di inventory..." class="w-full p-2 border rounded" oninput="filterInventory(this.value)"></div><div class="overflow-auto flex-1"><table class="w-full text-left text-sm"><thead class="bg-gray-100 text-gray-600 uppercase font-bold sticky top-0 z-10 shadow-sm"><tr><th class="p-4">Produk</th><th class="p-4">HPP/Jual</th><th class="p-4 text-center">73</th><th class="p-4 text-center">Induksi</th><th class="p-4 text-center">Kelanis</th></tr></thead><tbody class="divide-y product-row-container">${State.data.products.map(p => { const hpp = p.HPP || 0; const hppClass = hpp === 0 ? 'text-red-500 font-bold' : 'text-gray-500'; return `<tr class="hover:bg-gray-50 product-row"><td class="p-4"><div class="font-bold">${p['Nama Produk']}</div><div class="text-xs text-gray-500 font-mono">${p.Barcode}</div></td><td class="p-4"><div class="text-xs ${hppClass}">B: ${formatRp(hpp)}</div><div class="font-bold text-green-600">J: ${formatRp(p.Harga)}</div></td><td class="p-4 text-center font-bold ${checkStock(p['Stok Area Kasir adamart 73'])}">${p['Stok Area Kasir adamart 73']||0}</td><td class="p-4 text-center font-bold ${checkStock(p['Stok Area Kasir adamart induksi'])}">${p['Stok Area Kasir adamart induksi']||0}</td><td class="p-4 text-center font-bold ${checkStock(p['Stok Area Kasir adamart kelanis'])}">${p['Stok Area Kasir adamart kelanis']||0}</td></tr>`; }).join('')}</tbody></table></div></div></div>`,
            
            Reports: () => `
                <div class="space-y-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-lg shadow"><div class="text-xs text-gray-500">Total Omzet</div><div class="text-2xl font-bold text-blue-600" id="rep-omzet">Loading...</div></div>
                        <div class="bg-white p-4 rounded-lg shadow"><div class="text-xs text-gray-500">Estimasi Profit</div><div class="text-2xl font-bold text-green-600" id="rep-profit">Loading...</div></div>
                        <div class="bg-white p-4 rounded-lg shadow"><div class="text-xs text-gray-500">Total Transaksi</div><div class="text-2xl font-bold text-gray-700" id="rep-trx">-</div></div>
                        <div class="bg-white p-4 rounded-lg shadow"><div class="text-xs text-gray-500">Rata-rata Basket</div><div class="text-2xl font-bold text-purple-600" id="rep-avg">-</div></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-4 rounded-xl shadow md:col-span-2"><h4 class="font-bold mb-4 text-gray-700">Tren Penjualan (Per Cabang)</h4><canvas id="salesChart" style="max-height: 300px;"></canvas></div>
                        <div class="bg-white p-4 rounded-xl shadow"><h4 class="font-bold mb-4 text-gray-700">Metode Pembayaran</h4><canvas id="paymentChart" style="max-height: 300px;"></canvas></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow overflow-hidden h-80 flex flex-col"><div class="p-4 border-b bg-gray-50 font-bold text-gray-700 shrink-0">üî• Top 5 Produk Terlaris</div><div class="overflow-auto"><table class="w-full text-sm text-left"><thead class="bg-gray-100 sticky top-0"><tr><th class="p-3">Produk</th><th class="p-3 text-right">Qty</th><th class="p-3 text-right">Omzet</th></tr></thead><tbody id="topProductBody"></tbody></table></div></div>
                        <div class="bg-white rounded-xl shadow p-4"><h4 class="font-bold mb-4 text-gray-700">Download Laporan</h4><div class="space-y-3"><select id="reportPeriod" onchange="Pages.updateCharts()" class="w-full p-2 border rounded bg-white"><option value="monthly">Bulanan</option><option value="weekly">Mingguan</option></select><div class="flex gap-2"><button onclick="exportFinancialReportToCSV()" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 font-bold text-sm">üì• Keuangan</button><button onclick="exportProductPerformanceCSV()" class="flex-1 bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 font-bold text-sm">üì¶ Produk</button></div></div></div>
                    </div>
                </div>
            `,

            initReportCharts: () => { setTimeout(() => Pages.updateCharts(), 200); },
            updateCharts: () => {
                const periodElement = document.getElementById('reportPeriod');
                if (!periodElement) return;
                const period = periodElement.value;
                const grouped = {}, payments = {}, productPerformance = {};
                const branchData = { "adamart 73": {}, "adamart induksi": {}, "adamart kelanis": {} };
                const allDates = new Set();
                let totalOmzet = 0, totalProfit = 0;

                State.data.sales.forEach(s => {
                    const d = new Date(s.timestamp);
                    const key = period === 'monthly' ? d.toLocaleDateString('id-ID', {month:'short', year:'2-digit'}) : `W${Math.ceil(d.getDate()/7)} ${d.toLocaleDateString('id-ID', {month:'short'})}`;
                    allDates.add(key);
                    const branch = (s.area || "").toLowerCase();
                    if (branchData[branch]) {
                        if (!branchData[branch][key]) branchData[branch][key] = 0;
                        branchData[branch][key] += s.total;
                    }
                    let saleCost = 0;
                    let itemsList = s.cart || [];
                    if(itemsList.length === 0 && s.items) { 
                         s.items.split(', ').forEach(str => {
                            const parts = str.split(' x');
                            if(parts.length === 2) itemsList.push({name: parts[0].trim(), quantity: parseInt(parts[1])});
                         });
                    }
                    itemsList.forEach(item => {
                        const product = State.data.products.find(p => p['Nama Produk'].trim().toLowerCase() === item.name.toLowerCase());
                        const hpp = product ? (parseInt(product.HPP) || 0) : 0;
                        const price = item.price || (product ? product.Harga : 0);
                        saleCost += (hpp * item.quantity);
                        if(!productPerformance[item.name]) productPerformance[item.name] = {qty:0, rev:0};
                        productPerformance[item.name].qty += item.quantity;
                        productPerformance[item.name].rev += (price * item.quantity);
                    });
                    totalOmzet += s.total;
                    totalProfit += (s.total - saleCost);
                    const method = s.method || 'Unknown';
                    payments[method] = (payments[method] || 0) + s.total;
                });

                document.getElementById('rep-omzet').innerText = formatRp(totalOmzet);
                document.getElementById('rep-profit').innerText = formatRp(totalProfit);
                document.getElementById('rep-trx').innerText = State.data.sales.length;
                document.getElementById('rep-avg').innerText = formatRp(State.data.sales.length ? totalOmzet / State.data.sales.length : 0);

                const labels = Array.from(allDates).sort((a,b) => a.localeCompare(b));
                const ctxLine = document.getElementById('salesChart');
                if (ctxLine) {
                    if(State.charts.line) State.charts.line.destroy();
                    State.charts.line = new Chart(ctxLine, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Adamart 73', data: labels.map(l => branchData["adamart 73"][l] || 0), borderColor: '#3b82f6', tension: 0.1 },
                                { label: 'Induksi', data: labels.map(l => branchData["adamart induksi"][l] || 0), borderColor: '#10b981', tension: 0.1 },
                                { label: 'Kelanis', data: labels.map(l => branchData["adamart kelanis"][l] || 0), borderColor: '#f59e0b', tension: 0.1 }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
                const ctxPie = document.getElementById('paymentChart');
                if (ctxPie) {
                    if(State.charts.doughnut) State.charts.doughnut.destroy();
                    State.charts.doughnut = new Chart(ctxPie, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(payments),
                            datasets: [{ data: Object.values(payments), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'] }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
                const topBody = document.getElementById('topProductBody');
                if (topBody) {
                    topBody.innerHTML = Object.entries(productPerformance).sort((a,b) => b[1].rev - a[1].rev).slice(0, 5).map(([n, d]) => `<tr class="border-b"><td class="p-3 font-medium">${n}</td><td class="p-3 text-right">${d.qty}</td><td class="p-3 text-right font-bold text-blue-600">${formatRp(d.rev)}</td></tr>`).join('');
                }
            }
        };

        const EvoucherActions = {
            render: () => {
                const container = document.getElementById('content-area');
                if (EvoucherState.view === 'login') {
                    container.innerHTML = `<div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl border border-blue-100 text-center mt-10"><div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl">üé´</div><h2 class="text-2xl font-bold text-gray-800">E-Voucher System</h2><p class="text-sm text-gray-500 mb-6">Pilih Periode & Role</p><select id="evPeriod" onchange="EvoucherState.selectedPeriod = this.value" class="w-full p-3 border rounded-lg mb-4 bg-gray-50">${EvoucherActions.getMonthOptions()}</select><div class="grid grid-cols-2 gap-4"><button onclick="EvoucherActions.switchView('admin')" class="p-4 border rounded-xl hover:bg-blue-50 transition text-left group"><div class="font-bold text-blue-800">Administrator</div><div class="text-xs text-gray-500">Rekap Gaji</div></button><button onclick="EvoucherActions.switchView('merchant')" class="p-4 border rounded-xl hover:bg-green-50 transition text-left group"><div class="font-bold text-green-800">Kasir / Toko</div><div class="text-xs text-gray-500">Input Belanja</div></button></div></div>`;
                } else if (EvoucherState.view === 'admin') {
                    const totalPrincipal = EvoucherState.users.reduce((acc, curr) => acc + (curr.used || 0), 0);
                    const totalFee = totalPrincipal * 0.05;
                    container.innerHTML = `<div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-800">Dashboard Admin E-Voucher</h2><button onclick="EvoucherActions.switchView('login')" class="text-red-500 font-bold">Keluar</button></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"><div class="bg-white p-6 rounded-xl shadow border"><p class="text-gray-500 text-xs">Total Pokok</p><h3 class="text-2xl font-bold">${formatRp(totalPrincipal)}</h3></div><div class="bg-white p-6 rounded-xl shadow border"><p class="text-gray-500 text-xs">Fee Kopkar (5%)</p><h3 class="text-2xl font-bold text-green-600">${formatRp(totalFee)}</h3></div><div class="bg-blue-800 text-white p-6 rounded-xl shadow"><p class="text-blue-200 text-xs">Total Potong Gaji</p><h3 class="text-2xl font-bold">${formatRp(totalPrincipal + totalFee)}</h3></div></div><div class="bg-white rounded-xl shadow overflow-hidden"><div class="p-4 border-b flex justify-between"><h3 class="font-bold">Rincian Anggota</h3><button onclick="EvoucherActions.generateSummary()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm font-bold">Download Rekap Excel</button></div><div class="overflow-auto h-[500px]"><table class="w-full text-sm text-left"><thead class="bg-gray-50 sticky top-0"><tr><th class="p-3">Nama</th><th class="p-3">NIK</th><th class="p-3 text-right">Limit</th><th class="p-3 text-right">Terpakai</th><th class="p-3 text-right">Tagihan</th></tr></thead><tbody class="divide-y">${EvoucherState.users.map(u => { const used = u.used || 0; const bill = used + (used * 0.05); return `<tr class="hover:bg-gray-50"><td class="p-3 font-bold">${u.name}</td><td class="p-3 text-gray-500">${u.nik}</td><td class="p-3 text-right">${formatRp(u.limit)}</td><td class="p-3 text-right">${formatRp(used)}</td><td class="p-3 text-right font-bold text-blue-600">${formatRp(bill)}</td></tr>`; }).join('')}</tbody></table></div></div>`;
                } else if (EvoucherState.view === 'merchant') {
                    container.innerHTML = `<div class="max-w-md mx-auto bg-white rounded-xl shadow-lg overflow-hidden"><div class="bg-green-700 p-4 text-white flex justify-between items-center"><h2 class="font-bold text-lg">Kasir E-Voucher</h2><button onclick="EvoucherActions.switchView('login')" class="text-white/80 hover:text-white">‚úï</button></div><div class="p-6 space-y-4">${!EvoucherState.foundUser ? `<div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Cari Anggota</label><div class="flex gap-2"><input id="evSearchId" placeholder="No Anggota / NIK" class="w-full p-3 border rounded-lg font-mono text-lg" onkeydown="if(event.key==='Enter') EvoucherActions.checkUser()"><button onclick="EvoucherActions.checkUser()" class="bg-green-600 text-white px-4 rounded-lg font-bold">Cek</button></div></div>` : `<div class="bg-green-50 p-4 rounded-lg border border-green-200"><div class="font-bold text-green-800 text-lg">${EvoucherState.foundUser.name}</div><div class="flex justify-between text-sm mt-1"><span>Sisa Limit:</span><span class="font-bold">${formatRp(EvoucherState.foundUser.limit - (EvoucherState.foundUser.used || 0))}</span></div></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Total Belanja</label><input id="evAmount" type="number" placeholder="0" class="w-full p-3 border rounded-lg font-mono text-2xl font-bold text-gray-800"></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Lokasi / Keterangan</label><input id="evNotes" type="text" placeholder="Contoh: Adamart 73" class="w-full p-3 border rounded-lg"></div><div class="flex gap-2 pt-2"><button onclick="EvoucherState.foundUser=null; EvoucherActions.render()" class="flex-1 py-3 border rounded-lg font-bold text-gray-600">Batal</button><button onclick="EvoucherActions.submitTx()" class="flex-[2] py-3 bg-green-600 text-white rounded-lg font-bold shadow-lg">BAYAR SEKARANG</button></div>`}</div></div>`;
                }
            },
            switchView: async (viewName) => { EvoucherState.view = viewName; if (viewName !== 'login') { try { document.getElementById('loadingState').classList.remove('hidden'); document.getElementById('content-area').classList.add('hidden'); const res = await fetch(`${EVOUCHER_API_URL}?periode=${EvoucherState.selectedPeriod}`); const data = await res.json(); if (Array.isArray(data)) EvoucherState.users = data; EvoucherActions.render(); document.getElementById('loadingState').classList.add('hidden'); document.getElementById('content-area').classList.remove('hidden'); } catch(e) { alert("Gagal memuat data E-Voucher: " + e.message); EvoucherState.view = 'login'; EvoucherActions.render(); } } else { EvoucherActions.render(); } },
            checkUser: () => { const id = document.getElementById('evSearchId').value.trim(); const u = EvoucherState.users.find(u => String(u.noAnggota) === id || String(u.nik) === id); if (u) { EvoucherState.foundUser = u; EvoucherActions.render(); } else alert("Anggota tidak ditemukan!"); },
            submitTx: async () => { const amount = parseInt(document.getElementById('evAmount').value); const notes = document.getElementById('evNotes').value || "Adamart"; const user = EvoucherState.foundUser; if(!amount || amount <= 0) return alert("Masukkan nominal yang benar"); if(amount > (user.limit - (user.used||0))) return alert("Limit tidak mencukupi!"); if(!confirm("Proses transaksi E-Voucher?")) return; const payload = { idUser: user.noAnggota !== '-' ? user.noAnggota : user.nik, nama: user.name, merchant: "Adamart POS", nominal: amount, keterangan: notes, kodeVoucher: "KA" + Math.floor(Date.now()/1000), periode: EvoucherState.selectedPeriod, tanggal: new Date().toISOString().split('T')[0], id: "TX-" + Date.now() }; try { await fetch(EVOUCHER_API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) }); alert("‚úÖ Transaksi E-Voucher Berhasil!"); EvoucherState.foundUser = null; EvoucherActions.switchView('merchant'); } catch(e) { alert("Gagal: " + e.message); } },
            generateSummary: async () => { if(!confirm("Generate Rekap Gaji di Google Sheet?")) return; fetch(EVOUCHER_API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action: "generate_summary", periode: EvoucherState.selectedPeriod }) }); alert("Perintah dikirim. Cek Google Sheet 'Summary_Gaji' dalam beberapa detik."); },
            getMonthOptions: () => { let opts = ''; const startYear = 2025; for (let y = startYear; y <= 2026; y++) { for (let m = 0; m < 12; m++) { const val = `${m+1}-${y}`; const isCur = new Date().getMonth() === m && new Date().getFullYear() === y; opts += `<option value="${val}" ${isCur ? 'selected' : ''}>${new Date(y, m, 1).toLocaleDateString('id-ID', {month:'long', year:'numeric'})}</option>`; } } return opts; }
        };

        // GLOBAL ACTIONS
        const Actions = {
            createBatchPO: async (e) => { e.preventDefault(); const form = e.target; const selectVal = document.getElementById('supplierSelect').value; let supplier = selectVal === 'custom' ? document.getElementById('customSupplier').value.trim() : selectVal; if(State.tempBatchItems.length === 0) return alert("Belum ada item!"); const batchId = 'BATCH-' + Date.now(); const promises = []; const orderDate = form.elements['orderDate'].value; BRANCHES.forEach(branch => { if(document.getElementById(`branch-${branch.replace(/\s+/g, '-')}`).checked) { const poData = { type: 'purchase', batchNumber: batchId, branch: branch, supplier: supplier, orderDate: orderDate, status: 'pending', items: JSON.stringify(State.tempBatchItems), createdAt: new Date().toISOString() }; promises.push(window.addDoc(window.collection(window.db, "purchases"), poData)); } }); await Promise.all(promises); closeModal(); alert("Sukses! PO Batch berhasil dibuat."); loadAllData(); },
            
            // ACTION UPDATE: Approve Requisition -> DONE
            approveReq: async (id) => { 
                if(confirm("Kirim barang dan selesaikan permintaan?")) { 
                    try {
                        await window.updateDoc(window.doc(window.db, "requisitions", id), {status:'DONE'}); 
                        alert("Berhasil disetujui! Status berubah menjadi DONE.");
                        loadAllData(); 
                    } catch(e) {
                        alert("Gagal update: " + e.message);
                    }
                } 
            },
            
            updateStock: async (e) => { e.preventDefault(); const barcode = document.getElementById('barcode').value; const area = document.getElementById('targetArea').value; const qty = parseInt(document.getElementById('stockAmount').value); const hpp = parseInt(document.getElementById('hpp').value) || 0; const price = parseInt(document.getElementById('price').value) || 0; const name = document.getElementById('productName').value; const expiry = document.getElementById('expiryDate').value; const stockKey = `Stok Area Kasir ${area.toLowerCase()}`; try { const q = window.query(window.collection(window.db, "products"), window.where("Barcode", "==", barcode)); const snapshot = await window.getDocs(q); if (!snapshot.empty) { const docRef = snapshot.docs[0].ref; const updateData = { "Nama Produk": name, "Harga": price, "HPP": hpp }; if (qty !== 0) updateData[stockKey] = window.increment(qty); if (expiry) updateData["Tanggal Kadaluarsa"] = new Date(expiry).toISOString(); await window.updateDoc(docRef, updateData); } else { const newData = { Barcode: barcode, "Nama Produk": name, "Harga": price, "HPP": hpp, [stockKey]: qty }; if (expiry) newData["Tanggal Kadaluarsa"] = new Date(expiry).toISOString(); await window.addDoc(window.collection(window.db, "products"), newData); } fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'update_stock', data: { barcode, name, price, hpp, area: area.toLowerCase(), quantity: qty, expiryDate: expiry } }) }); alert("Stok Updated!"); document.getElementById('stockForm').reset(); loadAllData(); } catch (err) { console.error(err); alert("Gagal update stok: " + err.message); } }
        };

        function setupInventoryListeners() { const form = document.getElementById('stockForm'); if(form) form.addEventListener('submit', Actions.updateStock); }
        const Modals = { openBatchPO: () => { State.tempBatchItems = []; const content = `<h3 class="text-xl font-bold mb-4">Buat Batch PO</h3><form onsubmit="Actions.createBatchPO(event)"><div class="grid grid-cols-2 gap-4 mb-4"><div><select id="supplierSelect" class="p-2 border rounded w-full bg-white text-sm" required onchange="toggleSupplierInput(this)"><option value="">Pilih Supplier</option>${SUPPLIERS.map(s => `<option value="${s}">${s}</option>`).join('')}<option value="custom" class="font-bold text-blue-600">+ Input Manual</option></select><input id="customSupplier" type="text" placeholder="Nama Supplier..." class="p-2 border rounded w-full mt-2 hidden text-sm" disabled></div><input type="date" name="orderDate" class="p-2 border rounded w-full h-[38px] text-sm" required></div><div class="relative mb-4"><input id="smartSearchPO" placeholder="üîç Cari Barang / Scan Barcode..." class="w-full p-3 border-2 border-blue-400 rounded-lg font-bold focus:outline-none focus:ring-2 focus:ring-blue-600" autocomplete="off" oninput="searchProductForPO(this.value)"><div id="po-search-results" class="absolute z-50 w-full bg-white shadow-xl rounded-b-lg border border-gray-200 max-h-60 overflow-y-auto hidden"></div></div><div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-100"><div class="flex items-center gap-2 mb-2"><div class="w-32"><input id="item-barcode" placeholder="Barcode" class="w-full p-2 border rounded text-sm" readonly></div><div class="flex-1"><input id="item-name" placeholder="Nama Barang" class="w-full p-2 border rounded text-sm" readonly></div><div class="w-20"><input id="item-qty" type="number" placeholder="Qty" class="w-full p-2 border rounded text-sm font-bold bg-white border-blue-300"></div><div class="w-24"><input id="item-hpp" type="number" placeholder="HPP" class="w-full p-2 border rounded text-sm"></div><div class="w-24"><input id="item-price" type="number" placeholder="Jual" class="w-full p-2 border rounded text-sm"></div><button type="button" onclick="addItemToTemp()" class="bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700 font-bold">+</button></div><div id="temp-items-list" class="text-sm text-gray-600 max-h-40 overflow-y-auto space-y-1"><p class="text-xs text-gray-400 italic p-2">Belum ada item.</p></div></div><div class="mb-6"><label class="font-bold block mb-2 text-sm">Kirim ke:</label><div class="flex gap-4 flex-wrap">${BRANCHES.map(b => `<label class="flex items-center gap-2 text-sm"><input type="checkbox" id="branch-${b.replace(/\s+/g, '-')}" checked> ${b}</label>`).join('')}</div></div><button type="submit" class="w-full btn-primary py-2.5 rounded-lg bg-blue-600 text-white font-bold">Buat & Kirim PO</button></form>`; showModal(content); } };

        function showModal(c){ const d=document.createElement('div'); d.className='modal-overlay'; d.innerHTML=`<div class="modal-content p-6 relative shadow-2xl"><button onclick="closeModal()" class="absolute top-4 right-4">‚úï</button>${c}</div>`; document.body.appendChild(d); }
        function closeModal(){ document.querySelector('.modal-overlay')?.remove(); }
        window.autoFill = () => { const bc = document.getElementById('barcode').value; const p = State.data.products.find(i => String(i.Barcode) === bc); if (p) { document.getElementById('productName').value = p['Nama Produk']; document.getElementById('price').value = p['Harga']; document.getElementById('hpp').value = p['HPP'] || 0; } };
        window.autoFillPOItem = (b) => { const p = State.data.products.find(i => String(i.Barcode) === b); if (p) { document.getElementById('item-name').value = p['Nama Produk']; document.getElementById('item-price').value = p['Harga']; document.getElementById('item-hpp').value = p['HPP'] || 0; } };
        window.searchProductForPO = (val) => { const container = document.getElementById('po-search-results'); if(val.length < 2) { container.classList.add('hidden'); return; } const matches = State.data.products.filter(p => p['Nama Produk'].toLowerCase().includes(val.toLowerCase()) || String(p.Barcode).includes(val)).slice(0, 10); if(matches.length === 0) { container.innerHTML = '<div class="p-2 text-sm text-gray-500">Tidak ditemukan.</div>'; } else { container.innerHTML = matches.map(p => `<div class="p-2 hover:bg-blue-50 cursor-pointer border-b text-sm" onclick="selectProductForPO('${p.Barcode}')"><div class="font-bold text-gray-800">${p['Nama Produk']}</div><div class="text-xs text-gray-500 flex justify-between"><span>${p.Barcode}</span><span>HPP: ${formatRp(p.HPP || 0)}</span></div></div>`).join(''); } container.classList.remove('hidden'); };
        window.selectProductForPO = (barcode) => { const p = State.data.products.find(i => String(i.Barcode) === barcode); if(p) { document.getElementById('item-barcode').value = p.Barcode; document.getElementById('item-name').value = p['Nama Produk']; document.getElementById('item-hpp').value = p.HPP || 0; document.getElementById('item-price').value = p.Harga || 0; document.getElementById('po-search-results').classList.add('hidden'); document.getElementById('smartSearchPO').value = ''; document.getElementById('item-qty').focus(); } };
        window.addItemToTemp = () => { const barcode=document.getElementById('item-barcode').value; const name=document.getElementById('item-name').value; const qty=document.getElementById('item-qty').value; const hpp=document.getElementById('item-hpp').value; const price=document.getElementById('item-price').value; if(name && qty) { State.tempBatchItems.push({barcode, name, qty, hpp, price}); const list=State.tempBatchItems.map((i,x)=>`<div class="flex justify-between items-center bg-white p-2 rounded border"><div><span class="font-bold text-xs bg-gray-100 p-1 rounded mr-2">${i.barcode||'-'}</span><span class="font-bold">${i.name}</span> x${i.qty} <span class="text-xs text-gray-500">B:${formatRp(i.hpp)} J:${formatRp(i.price)}</span></div><button onclick="removeItemFromTemp(${x})" class="text-red-500 px-2">‚úï</button></div>`).join(''); document.getElementById('temp-items-list').innerHTML=list; document.getElementById('item-barcode').value=''; document.getElementById('item-name').value=''; document.getElementById('item-qty').value=''; document.getElementById('item-hpp').value=''; document.getElementById('item-price').value=''; document.getElementById('smartSearchPO').focus(); } };
        window.removeItemFromTemp = (i) => { State.tempBatchItems.splice(i,1); document.getElementById('temp-items-list').innerHTML=State.tempBatchItems.map((i,x)=>`<div class="flex justify-between items-center bg-white p-2 rounded border"><div><span class="font-bold">${i.name}</span> x${i.qty}</div><button onclick="removeItemFromTemp(${x})" class="text-red-500 px-2">‚úï</button></div>`).join(''); };
        window.toggleSupplierInput = (el) => { const i=document.getElementById('customSupplier'); if(el.value==='custom'){i.classList.remove('hidden');i.disabled=false;i.focus();}else{i.classList.add('hidden');i.disabled=true;} };
        window.filterInventory = (v) => { document.querySelectorAll('.product-row').forEach(r => r.style.display = r.innerText.toLowerCase().includes(v.toLowerCase()) ? '' : 'none'); };
        
        window.exportFinancialReportToCSV = () => { const grouped={}; const period=document.getElementById('reportPeriod').value; State.data.sales.forEach(s=>{ const d=new Date(s.timestamp); const key=period==='monthly'?d.toLocaleDateString('id-ID',{month:'long',year:'numeric'}):`Minggu ${Math.ceil(d.getDate()/7)} ${d.toLocaleDateString('id-ID',{month:'short'})}`; if(!grouped[key])grouped[key]={rev:0,cost:0,count:0}; let saleCost=0; let itemsList=s.cart||[]; if(itemsList.length===0&&s.items){s.items.split(', ').forEach(str=>{const parts=str.split(' x');if(parts.length===2)itemsList.push({name:parts[0].trim(),quantity:parseInt(parts[1])});});} itemsList.forEach(i=>{const p=State.data.products.find(prod=>prod['Nama Produk'].trim().toLowerCase()===i.name.toLowerCase()); saleCost+=(p?(parseInt(p.HPP)||0):0)*i.quantity;}); grouped[key].rev+=s.total; grouped[key].cost+=saleCost; grouped[key].count++; }); const rows=[['Periode','Total Transaksi','Total Omzet','Total HPP','Laba Kotor']]; Object.keys(grouped).reverse().forEach(k=>{rows.push([k,grouped[k].count,grouped[k].rev,grouped[k].cost,grouped[k].rev-grouped[k].cost]);}); const csv="data:text/csv;charset=utf-8,"+rows.map(e=>e.join(",")).join("\n"); const link=document.createElement("a"); link.href=encodeURI(csv); link.download="Laporan_Keuangan.csv"; link.click(); };
        window.exportProductPerformanceCSV = () => { const ps={}; State.data.sales.forEach(s=>{ let itemsList=s.cart||[]; if(itemsList.length===0&&s.items){s.items.split(', ').forEach(str=>{const parts=str.split(' x');if(parts.length===2)itemsList.push({name:parts[0].trim(),quantity:parseInt(parts[1])});});} itemsList.forEach(i=>{ const n=i.name; if(!ps[n])ps[n]={qty:0,rev:0}; ps[n].qty+=i.quantity; const p=State.data.products.find(prod=>prod['Nama Produk'].trim().toLowerCase()===n.toLowerCase()); const pr=i.price||(p?p.Harga:0); ps[n].rev+=(pr*i.quantity); }); }); const rows=[['Nama Barang','Terjual','Stok','HPP','Omzet','Laba']]; Object.keys(ps).forEach(n=>{ const s=ps[n]; const p=State.data.products.find(prod=>prod['Nama Produk'].trim().toLowerCase()===n.toLowerCase()); const st=p?(parseInt(p['Stok Area Kasir adamart 73']||0)+parseInt(p['Stok Area Kasir adamart induksi']||0)+parseInt(p['Stok Area Kasir adamart kelanis']||0)):0; const h=p?(parseInt(p.HPP)||0):0; rows.push([n,s.qty,st,h,s.rev,s.rev-(h*s.qty)]); }); const csv="data:text/csv;charset=utf-8,"+rows.map(e=>e.join(",")).join("\n"); const link=document.createElement("a"); link.href=encodeURI(csv); link.download="Laporan_Produk.csv"; link.click(); };

        function formatRp(n) { return "Rp " + (n || 0).toLocaleString('id-ID'); }
        function checkStock(v) { return (v || 0) < 10 ? 'text-red-600' : 'text-gray-800'; }
        function getStatusBadge(s) { return `<span class="px-2 py-1 rounded text-xs font-bold bg-gray-100">${s.toUpperCase()}</span>`; }

        window.Actions = Actions; window.Modals = Modals; window.Pages = Pages; window.State = State; window.EvoucherState = EvoucherState; window.EvoucherActions = EvoucherActions;
    </script>
</body>
</html>
